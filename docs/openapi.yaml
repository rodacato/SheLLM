openapi: 3.1.0
info:
  title: SheLLM API
  version: 0.1.0
  description: |
    SheLLM exposes local LLM CLI tools (Claude Code, Gemini CLI, Codex CLI, Cerebras)
    as a unified REST API compatible with both the OpenAI and Anthropic formats.

    ## Authentication

    **Client endpoints** (`/v1/*`) use Bearer token authentication.
    Tokens are managed via the Admin API or the `SHELLM_CLIENTS` environment variable.

    **Admin endpoints** (`/admin/*`) use HTTP Basic authentication.
    The password is set via the `SHELLM_ADMIN_PASSWORD` environment variable.

    ## Rate Limiting

    When rate-limited, responses include a `Retry-After` header (seconds).
    - **Global limit**: configurable via `SHELLM_GLOBAL_RPM` (default 30 RPM)
    - **Per-client limit**: configurable per API key (default 10 RPM)
    - **Admin brute-force**: 5 failed attempts per IP triggers a 5-minute lockout
  license:
    name: MIT
    identifier: MIT

servers:
  - url: http://localhost:6100
    description: Local development

tags:
  - name: Health
    description: Service health check
  - name: Chat Completions
    description: OpenAI-compatible chat completions
  - name: Messages
    description: Anthropic-compatible Messages API
  - name: Models
    description: List available models
  - name: Admin — Keys
    description: API key management
  - name: Admin — Logs
    description: Request log inspection
  - name: Admin — Stats
    description: Aggregated usage statistics

# ---------------------------------------------------------------------------
# Security schemes
# ---------------------------------------------------------------------------
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: Client API key (e.g. `shellm-a1b2c3…`)
    BasicAuth:
      type: http
      scheme: basic
      description: Admin password via `SHELLM_ADMIN_PASSWORD`

  # -------------------------------------------------------------------------
  # Reusable schemas
  # -------------------------------------------------------------------------
  schemas:
    # --- Health ---
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        providers:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ProviderStatus'
        queue:
          type: object
          properties:
            pending:
              type: integer
            active:
              type: integer
            max_concurrent:
              type: integer
        uptime_seconds:
          type: integer

    ProviderStatus:
      type: object
      properties:
        installed:
          type: boolean
        authenticated:
          type: boolean
        error:
          type: string

    # --- Models ---
    ModelList:
      type: object
      properties:
        object:
          type: string
          enum: [list]
        data:
          type: array
          items:
            $ref: '#/components/schemas/Model'

    Model:
      type: object
      properties:
        id:
          type: string
          example: claude
        object:
          type: string
          enum: [model]
        created:
          type: integer
          example: 0
        owned_by:
          type: string
          example: shellm

    # --- Chat Completions ---
    ChatCompletionRequest:
      type: object
      required: [model, messages]
      properties:
        model:
          type: string
          description: Provider name or alias
          example: claude
        messages:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/ChatMessage'
        max_tokens:
          type: integer
          minimum: 1
          maximum: 128000

    ChatMessage:
      type: object
      required: [role, content]
      properties:
        role:
          type: string
          enum: [system, user, assistant]
        content:
          type: string

    ChatCompletionResponse:
      type: object
      properties:
        id:
          type: string
          example: shellm-abc123
        object:
          type: string
          enum: [chat.completion]
        created:
          type: integer
        model:
          type: string
        choices:
          type: array
          items:
            type: object
            properties:
              index:
                type: integer
              message:
                $ref: '#/components/schemas/ChatMessage'
              finish_reason:
                type: string
                enum: [stop]
        usage:
          $ref: '#/components/schemas/Usage'

    Usage:
      type: object
      properties:
        prompt_tokens:
          type: [integer, 'null']
        completion_tokens:
          type: [integer, 'null']
        total_tokens:
          type: [integer, 'null']

    # --- Anthropic Messages ---
    MessagesRequest:
      type: object
      required: [model, messages, max_tokens]
      properties:
        model:
          type: string
          example: claude
        messages:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/AnthropicMessage'
        max_tokens:
          type: integer
          minimum: 1
          maximum: 128000
        system:
          type: string
          description: Optional system prompt
        stream:
          type: boolean
          description: Must be false (streaming not supported)
          enum: [false]

    AnthropicMessage:
      type: object
      required: [role, content]
      properties:
        role:
          type: string
          enum: [user, assistant]
        content:
          oneOf:
            - type: string
            - type: array
              items:
                $ref: '#/components/schemas/ContentBlock'

    ContentBlock:
      type: object
      required: [type, text]
      properties:
        type:
          type: string
          enum: [text]
        text:
          type: string

    MessagesResponse:
      type: object
      properties:
        id:
          type: string
          example: msg_shellm-abc123
        type:
          type: string
          enum: [message]
        role:
          type: string
          enum: [assistant]
        content:
          type: array
          items:
            $ref: '#/components/schemas/ContentBlock'
        model:
          type: string
        stop_reason:
          type: string
          enum: [end_turn]
        stop_sequence:
          type: ['null']
        usage:
          type: object
          properties:
            input_tokens:
              type: integer
            output_tokens:
              type: integer

    # --- Admin Keys ---
    KeyCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
          description: Unique client name
          example: my-app
        rpm:
          type: integer
          minimum: 1
          description: Requests per minute (default 10)
        models:
          type: array
          items:
            type: string
          description: Restrict key to specific models

    KeyUpdate:
      type: object
      properties:
        rpm:
          type: integer
          minimum: 1
        models:
          type: [array, 'null']
          items:
            type: string
        active:
          type: integer
          enum: [0, 1]

    KeyResponse:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        key_prefix:
          type: string
          example: shellm-a1
        rpm:
          type: integer
        models:
          type: [array, 'null']
          items:
            type: string
        active:
          type: integer
          enum: [0, 1]
        created_at:
          type: string
          format: date-time

    KeyCreateResponse:
      type: object
      properties:
        key:
          allOf:
            - $ref: '#/components/schemas/KeyResponse'
            - type: object
              properties:
                raw_key:
                  type: string
                  description: Full API key (shown only once)
                  example: shellm-a1b2c3d4e5f6…

    KeyRotateResponse:
      type: object
      properties:
        key:
          type: object
          properties:
            id:
              type: integer
            raw_key:
              type: string
            key_prefix:
              type: string

    # --- Admin Logs ---
    LogEntry:
      type: object
      properties:
        id:
          type: integer
        request_id:
          type: string
        client_name:
          type: string
        provider:
          type: string
        model:
          type: string
        status:
          type: integer
        duration_ms:
          type: integer
        queued_ms:
          type: integer
        tokens:
          type: integer
        cost_usd:
          type: number
        created_at:
          type: string
          format: date-time

    LogsResponse:
      type: object
      properties:
        logs:
          type: array
          items:
            $ref: '#/components/schemas/LogEntry'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    # --- Admin Stats ---
    StatsResponse:
      type: object
      properties:
        period:
          type: string
          enum: ['24h', '7d', '30d']
        total_requests:
          type: integer
        total_tokens:
          type: integer
        total_cost_usd:
          type: number
        avg_duration_ms:
          type: integer
        by_provider:
          type: object
          additionalProperties:
            type: integer
        by_status:
          type: object
          additionalProperties:
            type: integer
        active_clients:
          type: integer

    # --- Errors ---
    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        request_id:
          type: [string, 'null']
        retry_after:
          type: integer
          description: Present only on 429 responses

    OpenAIError:
      type: object
      properties:
        error:
          type: object
          properties:
            message:
              type: string
            type:
              type: string
              enum: [invalid_request_error, authentication_error, rate_limit_error, server_error]
            code:
              type: string
            param:
              type: ['null']

    AnthropicError:
      type: object
      properties:
        type:
          type: string
          enum: [error]
        error:
          type: object
          properties:
            type:
              type: string
              enum: [invalid_request_error, authentication_error, rate_limit_error, api_error]
            message:
              type: string

  # -------------------------------------------------------------------------
  # Reusable responses
  # -------------------------------------------------------------------------
  responses:
    Unauthorized:
      description: Missing or invalid credentials
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    RateLimited:
      description: Rate limit exceeded
      headers:
        Retry-After:
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

# ---------------------------------------------------------------------------
# Paths
# ---------------------------------------------------------------------------
paths:
  # --- Health ---
  /health:
    get:
      operationId: getHealth
      tags: [Health]
      summary: Service health check
      description: Returns provider status, queue depth, and uptime. No authentication required.
      security: []
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '500':
          description: Internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # --- Models ---
  /v1/models:
    get:
      operationId: listModels
      tags: [Models]
      summary: List available models
      description: Returns all configured providers and model aliases.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Model list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelList'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # --- Chat Completions ---
  /v1/chat/completions:
    post:
      operationId: createChatCompletion
      tags: [Chat Completions]
      summary: Create a chat completion
      description: |
        OpenAI-compatible endpoint. Sends the prompt to the requested provider
        CLI and returns the response in OpenAI format.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatCompletionRequest'
      responses:
        '200':
          description: Chat completion
          headers:
            X-Queue-Depth:
              schema:
                type: integer
            X-Queue-Active:
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatCompletionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
        '502':
          description: Provider CLI failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OpenAIError'
        '503':
          description: Provider unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OpenAIError'
        '504':
          description: Provider timeout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OpenAIError'

  # --- Anthropic Messages ---
  /v1/messages:
    post:
      operationId: createMessage
      tags: [Messages]
      summary: Create a message
      description: |
        Anthropic-compatible endpoint. Sends the prompt to the requested provider
        CLI and returns the response in Anthropic Messages format.
        Streaming is not supported (`stream` must be `false` or omitted).
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessagesRequest'
      responses:
        '200':
          description: Message response
          headers:
            X-Queue-Depth:
              schema:
                type: integer
            X-Queue-Active:
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessagesResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
        '502':
          description: Provider CLI failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnthropicError'
        '503':
          description: Provider unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnthropicError'
        '504':
          description: Provider timeout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnthropicError'

  # --- Admin Keys ---
  /admin/keys:
    get:
      operationId: listKeys
      tags: [Admin — Keys]
      summary: List all API keys
      security:
        - BasicAuth: []
      responses:
        '200':
          description: Key list
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      $ref: '#/components/schemas/KeyResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'

    post:
      operationId: createKey
      tags: [Admin — Keys]
      summary: Create a new API key
      description: |
        Returns the full `raw_key` in the response. This is the only time
        the full key is shown — store it securely.
      security:
        - BasicAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KeyCreate'
      responses:
        '201':
          description: Key created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KeyCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'

  /admin/keys/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer

    patch:
      operationId: updateKey
      tags: [Admin — Keys]
      summary: Update an API key
      security:
        - BasicAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KeyUpdate'
      responses:
        '200':
          description: Key updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  key:
                    $ref: '#/components/schemas/KeyResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'

    delete:
      operationId: deleteKey
      tags: [Admin — Keys]
      summary: Delete an API key
      security:
        - BasicAuth: []
      responses:
        '200':
          description: Key deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                    example: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'

  /admin/keys/{id}/rotate:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer

    post:
      operationId: rotateKey
      tags: [Admin — Keys]
      summary: Rotate an API key
      description: Generates a new key value for an existing key. The old key stops working immediately.
      security:
        - BasicAuth: []
      responses:
        '200':
          description: Key rotated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KeyRotateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'

  # --- Admin Logs ---
  /admin/logs:
    get:
      operationId: listLogs
      tags: [Admin — Logs]
      summary: List request logs
      security:
        - BasicAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: provider
          in: query
          schema:
            type: string
          description: Filter by provider name
        - name: client
          in: query
          schema:
            type: string
          description: Filter by client name
        - name: status
          in: query
          schema:
            type: string
          description: Status class (2–5) or exact code (e.g. 200, 429)
        - name: from
          in: query
          schema:
            type: string
            format: date-time
          description: Start date (ISO 8601)
        - name: to
          in: query
          schema:
            type: string
            format: date-time
          description: End date (ISO 8601)
      responses:
        '200':
          description: Paginated logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'

  # --- Admin Stats ---
  /admin/stats:
    get:
      operationId: getStats
      tags: [Admin — Stats]
      summary: Aggregated usage statistics
      security:
        - BasicAuth: []
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: ['24h', '7d', '30d']
            default: '24h'
      responses:
        '200':
          description: Statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'

  # --- Admin Models ---
  /admin/models:
    get:
      operationId: listModelsAdmin
      tags: [Models]
      summary: List models (admin)
      description: Same as `/v1/models` but uses Basic auth (for the admin dashboard).
      security:
        - BasicAuth: []
      responses:
        '200':
          description: Model list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
